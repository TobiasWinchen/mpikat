image: edd01:5000/eddbase:latest

before_script:
  - apt-get install python-ipaddress python2-coverage

test_production_base:
  image: edd01:5000/eddbase
  stage: test
  script:
    - python2-coverage run  -p --omit "*/site-packages/*,*test*,*/pipeline/*" --source="mpikat" test.py
  only:
    - pushes
    - merge_requests
  artifacts:
    untracked: true
    when: always


test_production_gated:
  image: edd01:5000/edd_gated_stokes
  stage: test
  script:
    - python2-coverage run -p --omit "*/site-packages/*,*test*" --source="mpikat" mpikat/effelsberg/edd/pipeline/test/testGatedPipeline.py
  only:
    - pushes
    - merge_requests
  artifacts:
    untracked: true
    when: always


    #test_coverage:
    #  stage: deploy
    #  dependencies:
    #    - test_production_gated
    #    - test_production_base
    #  script:
    #    - python2-coverage xml
    #  artifacts:
    #    reports:
    #      cobertura: coverage.xml
    #  when: on_success


test_debug_output:
  stage: deploy
  script:
    - cat debug.log
  when: on_failure


pages:
  stage: deploy
  dependencies:
    - test_production_gated
    - test_production_base
  script:
    - python-coverage combine
    - python-coverage html
    - mkdir public
    - mv htmlcov/ public/coverage
  artifacts:
    paths:
      - public
  only:
    - dev
